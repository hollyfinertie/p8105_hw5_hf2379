---
title: "Homework 5"
author: "Holly Finertie"
date: "11/5/2019"
output: github_document
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(rvest)
library(readr)
library(broom)
```

## Problem 1

```{r problem1, echo = TRUE, message = FALSE, warning = FALSE}
set.seed(10)

iris_with_missing = iris %>% 
  map_df(~replace(.x, sample(1:150, 20), NA)) %>%
  mutate(Species = as.character(Species))

update_missing = function(x) {
  
  if(is.numeric(x)) {
    replace(x, is.na(x), round(mean(x, na.rm = TRUE), digits = 1))
  }
  
  else if(!is.numeric(x)) {
    replace(x, is.na(x),"virginica")
  }
}

iris_no_missing = map_df(iris_with_missing, ~update_missing(.x))
```

## Problem 2

```{r problem2, echo = TRUE, message = FALSE, warning = FALSE}
read_file = function(x) {
  
  y = read_csv(x)
  
}

source_df = tibble(
   file = list.files(path = "./data/"), 
   path = str_c("./data/", file))

longitudinal_study_df = source_df %>% 
  mutate(
    load = map(source_df %>% pull(path), read_file)
  ) %>% 
  select(file, load) %>% 
  unnest(cols = load) %>% 
  pivot_longer(
    week_1:week_8, 
    names_to = "week",
    names_prefix = "week_", 
    values_to = "values"
  ) %>% 
  separate(file, into = c("arm", "observation"), sep = "_" ) %>% 
  mutate(
    observation = str_replace(observation, "\\.csv", "")
  )
 

study_plot = longitudinal_study_df %>% 
  group_by(observation) %>% 
  ggplot(aes(x = week, y = values, color = arm, group = arm)) + 
  geom_path() + 
  labs(
    title = "Differences in Study Arm Observation Values Over 8 Weeks",
    x = "Week",
    y = "Observation Values"
  )

study_plot
```

#### Comment on Plot

The mean value for the control arm stayed roughly the same around `r longitudinal_study_df %>% group_by(arm) %>% filter(arm == "con") %>%  summarize(mean = round(mean(values), digits = 2)) %>% pull(mean)` for 8 weeks while the mean value for the experiement arm increased to `r longitudinal_study_df %>% group_by(arm) %>% filter(arm == "exp" & week == 8) %>%  summarize(mean = round(mean(values), digits = 2)) %>% pull(mean)` by week 8. Assuming an increase in values is a good thing, the experimental group improved compared to the control group over 8 weeks of treatment. 

## Problem 3: 

```{r problem3, echo = TRUE, message = FALSE, warning = FALSE}
set.seed(10)

sim_regression = function(n = 30, beta0 = 2, beta1, var = 50) {
  
  sim_data = tibble(
    x = rnorm(n, mean = 0, sd = 1),
    y = beta0 + beta1 * x + rnorm(n, 0, var^0.5)
  )
  
  ls_fit = lm(y ~ x, data = sim_data)
  
  tidy(ls_fit)
  
  
    
}

sim_results_test = 
  rerun(100, sim_regression(beta1 = 0)) %>% 
  bind_rows() %>% 
  filter(term == "x") %>% 
  select(estimate, p.value)

sim_results = 
  tibble(beta1_input = c(0, 1, 2, 3, 4, 5, 6)) %>% 
  mutate(
    output_lists = map(.x = beta1_input, ~rerun(100, sim_regression(beta1 = .x))),
    estimate_dfs = map(output_lists, bind_rows)) %>% 
  unnest(estimate_dfs) %>% 
  filter(term == "x") %>% 
  select(beta1_input, estimate, p.value) %>% 
  mutate(
    reject = case_when(
      p.value > 0.05 ~ "No",
      p.value <= 0.05 ~ "Yes",
      TRUE     ~ ""
  ))
  

plot1 = sim_results %>% 
  group_by(beta1_input) %>% 
  summarize(
    n_sig = sum(reject == "Yes"), 
    p_sig = n_sig/n()
  ) %>% 
  ggplot(aes(x = beta1_input, y = p_sig)) + 
  geom_point() +
  labs(
    title = "Association Between Power and Effect Size", 
    x = "True Value of Beta1", 
    y = "Power"
  )

plot1

```


As expected, power increases with effect size. When beta1 increases, the effect size increases and therefore it is "easier" to correctly reject the null hypothesis. This increases the power. 



```{r}
plot2_data = sim_results %>% 
  group_by(beta1_input) %>% 
  mutate(
    mean_beta = mean(estimate)
  ) 

plot3_data = sim_results %>% 
  group_by(beta1_input) %>% 
  filter(reject == "Yes") %>% 
  summarize(
    mean_beta = mean(estimate)
  ) 


  ggplot(plot2_data, aes(x = beta1_input, y = mean_beta)) + 
  geom_point() +
  geom_point(data = plot3_data, color = "green") + 
  labs(
    title = "True Beta Value and Mean Estimated Beta Value
    where Green = Rejected Samples and Black = N", 
    x = "True Beta Value", 
    y = "Mean Estimated Value"
  )

```

